#!/usr/bin/env python3

import os, requests, datetime, logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
logger = logging.getLogger(__name__)

def get_weather_desc(code):
    # ะะพะดั WMO ะดะปั ะพะฟัะตะดะตะปะตะฝะธั ัะธะฟะฐ ะพัะฐะดะบะพะฒ
    codes = {
        0: "ััะฝะพ", 1: "ะฟัะตะธะผััะตััะฒะตะฝะฝะพ ััะฝะพ", 2: "ะฟะตัะตะผะตะฝะฝะฐั ะพะฑะปะฐัะฝะพััั", 3: "ะฟะฐัะผััะฝะพ",
        51: "ะปะตะณะบะฐั ะผะพัะพัั", 53: "ัะผะตัะตะฝะฝะฐั ะผะพัะพัั", 55: "ะฟะปะพัะฝะฐั ะผะพัะพัั",
        61: "ะฝะตะฑะพะปััะพะน ะดะพะถะดั", 63: "ะดะพะถะดั", 65: "ัะธะปัะฝัะน ะดะพะถะดั",
        71: "ะฝะตะฑะพะปััะพะน ัะฝะตะณ", 73: "ัะฝะตะณ", 75: "ัะธะปัะฝัะน ัะฝะตะณะพะฟะฐะด",
        77: "ัะฝะตะถะฝัะต ะทะตัะฝะฐ", 80: "ะปะธะฒะฝะตะฒัะน ะดะพะถะดั", 81: "ัะธะปัะฝัะน ะปะธะฒะตะฝั",
        85: "ะปะธะฒะฝะตะฒัะน ัะฝะตะณ", 86: "ัะธะปัะฝัะน ะปะธะฒะฝะตะฒัะน ัะฝะตะณ", 95: "ะณัะพะทะฐ"
    }
    return codes.get(code, "ะฑะตะท ะพัะฐะดะบะพะฒ")

def get_aqi_status(pm25):
    if pm25 <= 10: return "ะะดะตะฐะปัะฝะพ ัะธัััะน"
    if pm25 <= 25: return "ะงะธัััะน (ะฝะพัะผะฐ)"
    if pm25 <= 50: return "ะฃะผะตัะตะฝะฝะพ ะทะฐะณััะทะฝะตะฝะฝัะน"
    return "ะะฐะณััะทะฝะตะฝะฝัะน (ัะผะพะณ) โ๏ธ"

def get_mag_status(kp):
    if kp < 4: return "ะจัะธะปั (ัะฟะพะบะพะนะฝะพ)"
    if kp == 4: return "ะะตัััะพะนัะธะฒัะน (ัะปะฐะฑะฐั ะฒัะฟััะบะฐ)"
    return f"ะะฐะณะฝะธัะฝะฐั ะฑััั (ััะพะฒะตะฝั G{kp-4}) โ๏ธ"

def get_weather_data():
    url = (
        "https://api.open-meteo.com/v1/forecast?latitude=52.12&longitude=26.10"
        "&current=temperature_2m,relative_humidity_2m,apparent_temperature,surface_pressure,precipitation,cloud_cover,wind_speed_10m,wind_direction_10m,weather_code"
        "&hourly=temperature_2m,precipitation,weather_code&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset"
        "&timezone=auto&models=icon_seamless"
    )
    aq_url = "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=52.12&longitude=26.10&current=pm2_5"

    try:
        w = requests.get(url).json()
        aq = requests.get(aq_url).json()
        kp_res = requests.get("https://services.swpc.noaa.gov/products/noaa-scales.json", timeout=10).json()
        kp = int(kp_res['0'].get('rescale_value', 0))
    except: kp, aq = 0, {'current': {'pm2_5': 0}}

    return w, aq.get('current', {}).get('pm2_5', 0), kp

def main():
    now = datetime.datetime.now(datetime.timezone.utc) + datetime.timedelta(hours=3)
    hour, weekday = now.hour, now.weekday()
    w, pm25, kp = get_weather_data()

    cur, day, hr = w['current'], w['daily'], w['hourly']

    # ะะตัะฐะปัะฝัะน ะฟะพะธัะบ ะพัะฐะดะบะพะฒ
    precip_info = "ะฝะต ะพะถะธะดะฐัััั"
    for i in range(hour, hour + 12):
        if hr['precipitation'][i] > 0.1:
            precip_info = f"{get_weather_desc(hr['weather_code'][i])} ะฒ {i%24:02d}:00"
            break

    air_status = get_aqi_status(pm25)
    mag_status = get_mag_status(kp)

    data_str = (f"ะะธะฝัะบ: {cur['temperature_2m']}ยฐC (ะพััั. {cur['apparent_temperature']}ยฐC). "
                f"ะะฑะปะฐัะฝะพััั {cur['cloud_cover']}%, ะพัะฐะดะบะธ: {precip_info}. "
                f"ะะพะทะดัั: {air_status} (PM2.5: {pm25}). ะะฐะณะฝะธัะฝัะน ัะพะฝ: {mag_status}. "
                f"ะะฐะบะฐั {day['sunset'][1][-5:]}. ะะฐะฒััะฐ: {day['temperature_2m_min'][1]}..{day['temperature_2m_max'][1]}ยฐC")

    # 1. ะะะะฃะะะ (#ะฟัะพะณะฝะพะท) - ะัะฐัะบะพ ะธ ะฟัะพัะตััะธะพะฝะฐะปัะฝะพ
    if 7 <= hour <= 19:
        msg = (f"#ะฟัะพะณะฝะพะท\n\n"
               f"๐ก๏ธ **ะขะตะผะฟะตัะฐัััะฐ:** {cur['temperature_2m']}ยฐC (ะพััั. {cur['apparent_temperature']}ยฐC)\n"
               f"โ๏ธ **ะะฑะปะฐัะฝะพััั:** {cur['cloud_cover']}%\n"
               f"๐จ๏ธ **ะัะฐะดะบะธ:** {precip_info}\n"
               f"๐ **ะะพะทะดัั:** {air_status}\n"
               f"๐งฒ **ะะฐะณะฝะธัะฝัะน ัะพะฝ:** {mag_status}\n"
               f"๐จ **ะะตัะตั:** {cur['wind_speed_10m']} ะบะผ/ั\n\n"
               f"ะััะพัะฝะธะบ: ICON-BY")

    # 2. ะะะะะะขะะะ
    else:
        is_sun_evening = (weekday == 6 and hour >= 20)
        tag = "#ะฟัะพะณะฝะพะทัััะพ" if hour == 5 else ("#ะฟัะพะณะฝะพะทะฝะตะดะตะปั" if is_sun_evening else "#ะฟัะพะณะฝะพะทะฒะตัะตั")

        # ะะฑะฝะพะฒะปะตะฝะฝัะต ะฟัะพะผะฟัั ั ััะตะฑะพะฒะฐะฝะธะตะผ ะบัะฐัะบะพััะธ ะธ ะฟัะพั. ัะตัะผะธะฝะพะฒ
        prompts = {
            "#ะฟัะพะณะฝะพะทัััะพ": f"ะขั ะผะตัะตะพัะพะปะพะณ-ะฐะฝะฐะปะธัะธะบ ะฟัะพัะธ ๐จโ๐ฌ. ะกะตะนัะฐั ัััะพ ๐. ะะฐ ะพัะฝะพะฒะต ะดะฐะฝะฝัั: {data_str} ัะดะตะปะฐะน ะะะะกะะะะะฌะะ ะะะะขะะฃะฎ ัะฒะพะดะบั ะฝะฐ ัััะพ ะธ ะดะตะฝั. ะะฐะฝะฝัะต ะพ ัะตะผะฟ. (ัะตะฐะปัะฝะพะน ะธ ะพัััะฐะตะผะพะน ๐งค), ะพัะฐะดะบะฐั (ัะธะฟ/ะฒัะตะผั) ๐จ๏ธ, ะบะฐัะตััะฒะต ะฒะพะทะดััะฐ ๐ ะธ ะฒะพััะพะดะต. ะัะฐัะบะพ ะพะฑัััะฝะธ ะณะปะพะฑะฐะปัะฝัะน ัะพะฝ: ะบะฐะบะธะต ะฒะพะทะดััะฝัะต ะผะฐััั (ัะธะบะปะพะฝั/ะฐะฝัะธัะธะบะปะพะฝั) ะฒะปะธััั ะฝะฐ ะะธะฝัะบ ะธ ะะฐะปะตััะต ะธ ะบะฐะบะธะต ะธะทะผะตะฝะตะฝะธั ะฟัะธะฝะตััั ๐ง๐พ๐ฃโโ๏ธ.ะกัะธะปั:ะบัะฐัะบะพ, ะฑะตะท ะฒะพะดั, ัะผะพะดะทะธ ะฒััะฐะฒะปัะน ะฒ ะฝะฐัะฐะปะพ, ะฟะพัะพะดััะธะต ะฟะพ ัะผััะปั ๐ฐ๏ธ๐๐งโ๐โ๏ธ๐ก๏ธ๐งฒ๐จ๏ธ๐งคโ๏ธ๐จ๐ง๐พ๐๐ฌ๏ธ.",
            "#ะฟัะพะณะฝะพะทะฒะตัะตั": f"ะขั ะผะตัะตะพัะพะปะพะณ-ะฐะฝะฐะปะธัะธะบ ะฟัะพัะธ ๐จโ๐ฌ. ะกะตะนัะฐั ะฒะตัะตั ๐. ะะฐ ะพัะฝะพะฒะต ะดะฐะฝะฝัั: {data_str} ัะดะตะปะฐะน ะะะะกะะะะะฌะะ ะะะะขะะฃะฎ ัะฒะพะดะบั ะฝะฐ ะฒะตัะตั, ะฝะพัั ะธ ัััะพ. ะัะฐัะบะพ ะพะฑัััะฝะธ ะณะปะพะฑะฐะปัะฝัะน ัะพะฝ: ะบะฐะบะธะต ะฒะพะทะดััะฝัะต ะผะฐััั (ัะธะบะปะพะฝั/ะฐะฝัะธัะธะบะปะพะฝั) ะฒะปะธััั ะฝะฐ ะะธะฝัะบ ะธ ะะฐะปะตััะต ะธ ะบะฐะบะธะต ะธะทะผะตะฝะตะฝะธั ะฟัะธะฝะตััั ๐โ๏ธ. ะกัะธะปั: ะบัะฐัะบะพ,ะฑะตะท ะฒะพะดั, ัะผะพะดะทะธ ะฒััะฐะฒะปัะน ะฒ ะฝะฐัะฐะปะพ, ะฟะพัะพะดััะธะต ะฟะพ ัะผััะปั ๐๐ฐ๏ธ๐๐งโ๐โ๏ธ๐ก๏ธ๐งฒ๐จ๏ธ๐งคโ๏ธ๐จ๐ง๐พ๐.",
            "#ะฟัะพะณะฝะพะทะฝะตะดะตะปั": f"ะขั ะผะตัะตะพัะพะปะพะณ-ะฐะฝะฐะปะธัะธะบ ะฟัะพัะธ ๐จโ๐ฌ. ะะพัะบัะตัะตะฝัะต ๐. ะะฐ ะพัะฝะพะฒะต ะดะฐะฝะฝัั ะฝะฐ ะฝะตะดะตะปั: {day['temperature_2m_max']} ัะดะตะปะฐะน ะะะะกะะะะะฌะะ ะะะะขะะฃะฎ ัะฒะพะดะบั ะฝะฐ ะบะฐะถะดัะน ะดะตะฝั ะฝะตะดะตะปะธ. ะกะดะตะปะฐะน ะกะะะขะฃะฎ ะฐะฝะฐะปะธัะธะบั. ะะฟะธัะธ ัะผะตะฝั ะฒะพะทะดััะฝัั ะผะฐัั, ัะธะบะปะพะฝั/ะฐะฝัะธัะธะบะปะพะฝั ะธ ะธั ะฒะปะธัะฝะธะต ะฝะฐ ะะฐะปะตััะต ะธ ะบะฐะบะธะต ะธะทะผะตะฝะตะฝะธั ะฟัะธะฝะตััั ๐ง๐พ.ะกัะธะปั:ะบัะฐัะบะพ, ะฑะตะท ะฒะพะดั, ัะผะพะดะทะธ ะฒััะฐะฒะปัะน ะฒ ะฝะฐัะฐะปะพ, ะฟะพัะพะดััะธะต ะฟะพ ัะผััะปั ๐ฐ๏ธ๐๐งโ๐โ๏ธ๐ก๏ธ๐งฒ๐จ๏ธ๐งคโ๏ธ๐จ๐ง๐พ๐."
        }

        logger.info(f"ะะฐะฟัะพั ะะ ะดะปั {tag}")
        ai_text = "ะะฝะฐะปะธัะธะบะฐ ะฝะตะดะพัััะฟะฝะฐ."
        try:
            res = requests.post("https://openrouter.ai/api/v1/chat/completions",
                headers={"Authorization": f"Bearer {os.getenv('OPENROUTER_API_KEY')}"},
                json={"model": "google/gemini-2.0-flash-001", "messages": [{"role": "user", "content": prompts[tag]}], "temperature": 0.7}, timeout=45)
            ai_text = res.json()['choices'][0]['message']['content'].strip()
        except Exception as e: logger.error(f"AI Error: {e}")

        msg = f"{tag}\n\n{ai_text}\n\nะััะพัะฝะธะบ: ICON-BY & ECMWF"

    requests.post(f"https://api.telegram.org/bot{os.getenv('TELEGRAM_TOKEN')}/sendMessage",
                  json={'chat_id': os.getenv('CHANNEL_ID'), 'text': msg, 'parse_mode': 'Markdown'})

if __name__ == "__main__":
    main()
