#!/usr/bin/env python3

import os, requests, datetime, logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def get_weather_desc(code):
    # –ö–æ–¥—ã WMO –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ—Å–∞–¥–∫–æ–≤
    codes = {
        0: "—è—Å–Ω–æ", 1: "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ", 2: "–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å", 3: "–ø–∞—Å–º—É—Ä–Ω–æ",
        51: "–ª–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å", 53: "—É–º–µ—Ä–µ–Ω–Ω–∞—è –º–æ—Ä–æ—Å—å", 55: "–ø–ª–æ—Ç–Ω–∞—è –º–æ—Ä–æ—Å—å",
        61: "–Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å", 63: "–¥–æ–∂–¥—å", 65: "—Å–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
        71: "–Ω–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥", 73: "—Å–Ω–µ–≥", 75: "—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥",
        77: "—Å–Ω–µ–∂–Ω—ã–µ –∑–µ—Ä–Ω–∞", 80: "–ª–∏–≤–Ω–µ–≤—ã–π –¥–æ–∂–¥—å", 81: "—Å–∏–ª—å–Ω—ã–π –ª–∏–≤–µ–Ω—å",
        85: "–ª–∏–≤–Ω–µ–≤—ã–π —Å–Ω–µ–≥", 86: "—Å–∏–ª—å–Ω—ã–π –ª–∏–≤–Ω–µ–≤—ã–π —Å–Ω–µ–≥", 95: "–≥—Ä–æ–∑–∞"
    }
    return codes.get(code, "–±–µ–∑ –æ—Å–∞–¥–∫–æ–≤")

def get_aqi_status(pm25):
    if pm25 <= 10: return "–ò–¥–µ–∞–ª—å–Ω–æ —á–∏—Å—Ç—ã–π"
    if pm25 <= 25: return "–ß–∏—Å—Ç—ã–π (–Ω–æ—Ä–º–∞)"
    if pm25 <= 50: return "–£–º–µ—Ä–µ–Ω–Ω–æ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã–π"
    return "–ó–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã–π (—Å–º–æ–≥) ‚ö†Ô∏è"

def get_mag_status(kp):
    if kp < 4: return "–®—Ç–∏–ª—å (—Å–ø–æ–∫–æ–π–Ω–æ)"
    if kp == 4: return "–ù–µ—É—Å—Ç–æ–π—á–∏–≤—ã–π (—Å–ª–∞–±–∞—è –≤—Å–ø—ã—à–∫–∞)"
    return f"–ú–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è (—É—Ä–æ–≤–µ–Ω—å G{kp-4}) ‚ö†Ô∏è"

def get_weather_data():
    url = (
        "https://api.open-meteo.com/v1/forecast?latitude=52.12&longitude=26.10"
        "&current=temperature_2m,relative_humidity_2m,apparent_temperature,surface_pressure,precipitation,cloud_cover,wind_speed_10m,wind_direction_10m,weather_code"
        "&hourly=temperature_2m,precipitation,weather_code&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset"
        "&timezone=auto&models=icon_seamless"
    )
    aq_url = "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=52.12&longitude=26.10&current=pm2_5"

    try:
        w = requests.get(url).json()
        aq = requests.get(aq_url).json()
        kp_res = requests.get("https://services.swpc.noaa.gov/products/noaa-scales.json", timeout=10).json()
        kp = int(kp_res['0'].get('rescale_value', 0))
    except: kp, aq = 0, {'current': {'pm2_5': 0}}

    return w, aq.get('current', {}).get('pm2_5', 0), kp

def main():
    now = datetime.datetime.now(datetime.timezone.utc) + datetime.timedelta(hours=3)
    hour, weekday = now.hour, now.weekday()
    w, pm25, kp = get_weather_data()

    cur, day, hr = w['current'], w['daily'], w['hourly']

    # –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –æ—Å–∞–¥–∫–æ–≤
    precip_info = "–Ω–µ –æ–∂–∏–¥–∞—é—Ç—Å—è"
    for i in range(hour, hour + 12):
        if hr['precipitation'][i] > 0.1:
            precip_info = f"{get_weather_desc(hr['weather_code'][i])} –≤ {i%24:02d}:00"
            break

    air_status = get_aqi_status(pm25)
    mag_status = get_mag_status(kp)

    data_str = (f"–ü–∏–Ω—Å–∫: {cur['temperature_2m']}¬∞C (–æ—â—É—â. {cur['apparent_temperature']}¬∞C). "
                f"–û–±–ª–∞—á–Ω–æ—Å—Ç—å {cur['cloud_cover']}%, –æ—Å–∞–¥–∫–∏: {precip_info}. "
                f"–í–æ–∑–¥—É—Ö: {air_status} (PM2.5: {pm25}). –ú–∞–≥–Ω–∏—Ç–Ω—ã–π —Ñ–æ–Ω: {mag_status}. "
                f"–ó–∞–∫–∞—Ç {day['sunset'][1][-5:]}. –ó–∞–≤—Ç—Ä–∞: {day['temperature_2m_min'][1]}..{day['temperature_2m_max'][1]}¬∞C")

    # 1. –î–ï–ñ–£–†–ö–ê (#–ø—Ä–æ–≥–Ω–æ–∑) - –ö—Ä–∞—Ç–∫–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ
    if 7 <= hour <= 19:
        msg = (f"#–ø—Ä–æ–≥–Ω–æ–∑\n\n"
               f"üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:** {cur['temperature_2m']}¬∞C (–æ—â—É—â. {cur['apparent_temperature']}¬∞C)\n"
               f"‚òÅÔ∏è **–û–±–ª–∞—á–Ω–æ—Å—Ç—å:** {cur['cloud_cover']}%\n"
               f"üå®Ô∏è **–û—Å–∞–¥–∫–∏:** {precip_info}\n"
               f"üçÉ **–í–æ–∑–¥—É—Ö:** {air_status}\n"
               f"üß≤ **–ú–∞–≥–Ω–∏—Ç–Ω—ã–π —Ñ–æ–Ω:** {mag_status}\n"
               f"üí® **–í–µ—Ç–µ—Ä:** {cur['wind_speed_10m']} –∫–º/—á\n\n"
               f"–ò—Å—Ç–æ—á–Ω–∏–∫: ICON-BY")
        logger.info("–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –¥–µ–∂—É—Ä–∫–∞.")

    # 2. –ê–ù–ê–õ–ò–¢–ò–ö–ê
    else:
        is_sun_evening = (weekday == 6 and hour >= 20)
        tag = "#–ø—Ä–æ–≥–Ω–æ–∑—É—Ç—Ä–æ" if hour == 5 else ("#–ø—Ä–æ–≥–Ω–æ–∑–Ω–µ–¥–µ–ª—è" if is_sun_evening else "#–ø—Ä–æ–≥–Ω–æ–∑–≤–µ—á–µ—Ä")

        prompts = {
            "#–ø—Ä–æ–≥–Ω–æ–∑—É—Ç—Ä–æ": f"–¢—ã –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫ –ø—Ä–æ—Ñ–∏ üë®‚Äçüî¨. –°–µ–π—á–∞—Å —É—Ç—Ä–æ üåÖ. –ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö: {data_str} —Å–¥–µ–ª–∞–π –ö–†–ê–¢–ö–£–Æ —Å–≤–æ–¥–∫—É –Ω–∞ —É—Ç—Ä–æ –∏ –¥–µ–Ω—å –≤ –æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ —É–∫–∞–∂–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ(—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã,–æ—Å–∞–¥–∫–∏,–≤–µ—Ç–µ—Ä,–æ–±–ª–∞—á–Ω–æ—Å—Ç—å). –î–∞–Ω–Ω—ã–µ –æ —Ç–µ–º–ø. (—Ä–µ–∞–ª—å–Ω–æ–π –∏ –æ—â—É—â–∞–µ–º–æ–π üß§), –æ—Å–∞–¥–∫–∞—Ö (—Ç–∏–ø/–≤—Ä–µ–º—è) üå®Ô∏è, –∫–∞—á–µ—Å—Ç–≤–µ –≤–æ–∑–¥—É—Ö–∞ üçÉ –∏ –≤–æ—Å—Ö–æ–¥–µ. –ö—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–æ–Ω: –∫–∞–∫–∏–µ –≤–æ–∑–¥—É—à–Ω—ã–µ –º–∞—Å—Å—ã (—Ü–∏–∫–ª–æ–Ω—ã/–∞–Ω—Ç–∏—Ü–∏–∫–ª–æ–Ω—ã –∏ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–µ) –≤–ª–∏—è—é—Ç –Ω–∞ –ü–∏–Ω—Å–∫ –∏ –ü–∞–ª–µ—Å—å–µ –∏ –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–Ω–µ—Å—ë—Ç üáßüáæüö£‚Äç‚ôÇÔ∏è.–°—Ç–∏–ª—å:–∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –≤–æ–¥—ã,–≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –¥–ª—è —Å–≤–æ–¥–∫–∏, —ç–º–æ–¥–∑–∏ –≤—Å—Ç–∞–≤–ª—è–π –≤ –Ω–∞—á–∞–ª–æ, –ø–æ—Ö–æ–¥—è—â–∏–µ –ø–æ —Å–º—ã—Å–ª—É üõ∞Ô∏èüìâüßä‚òîüåÄ‚òÄÔ∏èüå°Ô∏èüß≤üå®Ô∏èüß§‚òÅÔ∏èüí®üáßüáæüåÖüå¨Ô∏è.",
            "#–ø—Ä–æ–≥–Ω–æ–∑–≤–µ—á–µ—Ä": f"–¢—ã –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫ –ø—Ä–æ—Ñ–∏ üë®‚Äçüî¨. –°–µ–π—á–∞—Å –≤–µ—á–µ—Ä üåô. –ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö: {data_str} —Å–¥–µ–ª–∞–π –ö–†–ê–¢–ö–£–Æ —Å–≤–æ–¥–∫—É –Ω–∞ –≤–µ—á–µ—Ä, –Ω–æ—á—å –∏ —É—Ç—Ä–æ –≤ –æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ —É–∫–∞–∂–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ(—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã,–æ—Å–∞–¥–∫–∏,–≤–µ—Ç–µ—Ä,–æ–±–ª–∞—á–Ω–æ—Å—Ç—å). –ö—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏  –∫–∞–∫–∏–µ –≤–æ–∑–¥—É—à–Ω—ã–µ –º–∞—Å—Å—ã (—Ü–∏–∫–ª–æ–Ω—ã/–∞–Ω—Ç–∏—Ü–∏–∫–ª–æ–Ω—ã–∏ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–µ) –≤–ª–∏—è—é—Ç –Ω–∞ –ü–∏–Ω—Å–∫ –∏ –ü–∞–ª–µ—Å—å–µ –∏ –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–Ω–µ—Å—ë—Ç üåÄ‚òÄÔ∏è. –°—Ç–∏–ª—å: –∫—Ä–∞—Ç–∫–æ,–±–µ–∑ –≤–æ–¥—ã,–≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –¥–ª—è —Å–≤–æ–¥–∫–∏, —ç–º–æ–¥–∑–∏ –≤—Å—Ç–∞–≤–ª—è–π –≤ –Ω–∞—á–∞–ª–æ, –ø–æ—Ö–æ–¥—è—â–∏–µ –ø–æ —Å–º—ã—Å–ª—É üå†üõ∞Ô∏èüìâüßä‚òîüåÄ‚òÄÔ∏èüå°Ô∏èüß≤üå®Ô∏èüß§‚òÅÔ∏èüí®üáßüáæüåÖ.",
            "#–ø—Ä–æ–≥–Ω–æ–∑–Ω–µ–¥–µ–ª—è": f"–¢—ã –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫ –ø—Ä–æ—Ñ–∏ üë®‚Äçüî¨. –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ üìÖ. –ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–µ–¥–µ–ª—é: {day['temperature_2m_max']} —Å–¥–µ–ª–∞–π –ö–†–ê–¢–ö–£–Æ —Å–≤–æ–¥–∫—É –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –≤ –æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ —É–∫–∞–∂–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ(—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã,–æ—Å–∞–¥–∫–∏,–≤–µ—Ç–µ—Ä,–æ–±–ª–∞—á–Ω–æ—Å—Ç—å). –°–¥–µ–ª–∞–π –°–ñ–ê–¢–£–Æ –∞–Ω–∞–ª–∏—Ç–∏–∫—É. –û–ø–∏—à–∏ —Å–º–µ–Ω—É –≤–æ–∑–¥—É—à–Ω—ã—Ö –º–∞—Å—Å, —Ü–∏–∫–ª–æ–Ω—ã/–∞–Ω—Ç–∏—Ü–∏–∫–ª–æ–Ω—ã (–∏ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–µ) –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ü–∞–ª–µ—Å—å–µ –∏ –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–Ω–µ—Å—ë—Ç üáßüáæ.–°—Ç–∏–ª—å:–∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –≤–æ–¥—ã, –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –¥–ª—è —Å–≤–æ–¥–∫–∏,—ç–º–æ–¥–∑–∏ –≤—Å—Ç–∞–≤–ª—è–π –≤ –Ω–∞—á–∞–ª–æ, –ø–æ—Ö–æ–¥—è—â–∏–µ –ø–æ —Å–º—ã—Å–ª—É üõ∞Ô∏èüìâüßä‚òîüåÄ‚òÄÔ∏èüå°Ô∏èüß≤üå®Ô∏èüß§‚òÅÔ∏èüí®üáßüáæüåÖ."
        }

        current_prompt = prompts[tag]
        logger.info(f"–û–¢–ü–†–ê–í–ö–ê –ü–†–û–ú–ü–¢–ê –í –ò–ò ({tag}): {current_prompt}")

        ai_text = "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."
        try:
            res = requests.post("https://openrouter.ai/api/v1/chat/completions",
                headers={"Authorization": f"Bearer {os.getenv('OPENROUTER_API_KEY')}"},
                json={"model": "google/gemini-2.0-flash-001", "messages": [{"role": "user", "content": current_prompt}], "temperature": 0.7}, timeout=45)

            if res.status_code == 200:
                ai_text = res.json()['choices'][0]['message']['content'].strip()
                logger.info(f"–û–¢–í–ï–¢ –û–¢ –ò–ò –£–°–ü–ï–®–ù–û –ü–û–õ–£–ß–ï–ù: {ai_text}")
            else:
                logger.error(f"–û—à–∏–±–∫–∞ API OpenRouter: {res.status_code} - {res.text}")

        except Exception as e:
            logger.error(f"AI Error: {e}")

        msg = f"{tag}\n\n{ai_text}\n\n–ò—Å—Ç–æ—á–Ω–∏–∫: ICON-BY & ECMWF"

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (—Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π)
    try:
        tg_res = requests.post(f"https://api.telegram.org/bot{os.getenv('TELEGRAM_TOKEN')}/sendMessage",
                      json={'chat_id': os.getenv('CHANNEL_ID'), 'text': msg, 'parse_mode': 'Markdown'})
        if tg_res.status_code == 200:
            logger.info("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram.")
        else:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {tg_res.status_code} - {tg_res.text}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram: {e}")

if __name__ == "__main__":
    main()
